name: Capture Livestream Screenshot

on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  capture:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.58.2-noble
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v6

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y unzip
          # Install gh CLI (needed for release upload and API calls)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
          apt-get update
          apt-get install -y gh

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Playwright
        run: bun install playwright

      - name: Capture livestream frame
        run: bun run scripts/capture-livestream.mjs

      - name: Create release (first run only)
        run: gh release create livestream --title "Livestream Screenshots" --notes "Auto-updated livestream capture" || true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload screenshot to release
        run: gh release upload livestream livestream.jpg --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger site redeploy
        run: gh api repos/${{ github.repository }}/dispatches -f event_type=livestream-update
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
