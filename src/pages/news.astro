---
// biome-ignore lint/correctness/noUnusedImports: used in Astro template below
import Layout from "../layouts/Layout.astro";

interface NewsEntry {
	date: string;
	day: string;
	title: string;
	body: string;
	type: "current" | "update";
}

// To add new news entries, edit or create a JSON file (e.g., `entries.json`)
// under `src/news/<YYYY>/<MM>/`. The file should contain an array of objects
// matching the `NewsEntry` interface.
const newsFiles = import.meta.glob<{ default: NewsEntry[] }>("../news/**/*.json", { eager: true });
const entries: NewsEntry[] = Object.values(newsFiles)
	.flatMap((file) => file.default)
	.sort((a, b) => {
		if (a.date !== b.date) {
			return new Date(b.date).getTime() - new Date(a.date).getTime();
		}
		if (a.type !== b.type) {
			return a.type === "current" ? -1 : 1;
		}
		return a.title.localeCompare(b.title);
	});

// Group entries by Year > Month
const groupedEntries = entries.reduce((acc, entry) => {
	const d = new Date(`${entry.date}T00:00:00`);
	const year = d.getFullYear();
	const month = d.toLocaleString("en-US", { month: "long" }).toUpperCase();

	if (!acc[year]) acc[year] = {};
	if (!acc[year][month]) acc[year][month] = [];
	
	acc[year][month].push(entry);
	return acc;
}, {} as Record<number, Record<string, NewsEntry[]>>);

const years = Object.keys(groupedEntries).map(Number).sort((a, b) => b - a);

// biome-ignore lint/correctness/noUnusedVariables: used in Astro template below
function formatDay(date: string, day: string): string {
	const d = new Date(`${date}T00:00:00`);
	const dayNum = String(d.getDate()).padStart(2, '0');
	return `DAY ${dayNum} // ${day.toUpperCase()}`;
}
---

<Layout title="CCCP.PS â€” News">
	<section class="news" aria-label="News">
		<h1 class="page-title">NEWS</h1>
		<hr class="news-divider" aria-hidden="true" />

		<div class="news-hierarchy">
			{years.map(year => (
				<div class="year-group">
					<h2 class="year-header" aria-label={`Year ${year}`}>{year}</h2>
					
					{Object.keys(groupedEntries[year]).map(month => (
						<div class="month-group">
							<h3 class="month-header">
								<span class="month-bracket">[</span>
								{month}
								<span class="month-bracket">]</span>
							</h3>
							
							<div class="timeline" role="list">
								{groupedEntries[year][month].map((entry, i) => (
									<div
										class:list={["timeline-entry", { "is-current": entry.type === "current" }]}
										role="listitem"
										style={`animation-delay: ${0.1 + i * 0.08}s`}
									>
										<div class="timeline-marker" aria-hidden="true">
											<span class:list={["timeline-dot", { "dot-current": entry.type === "current" }]} />
										</div>
										<div class="timeline-content">
											<time class="timeline-date" datetime={entry.date}>
												{formatDay(entry.date, entry.day)}
											</time>
											<h4 class="timeline-title">{entry.title}</h4>
											<p class="timeline-body">{entry.body}</p>
										</div>
									</div>
								))}
							</div>
						</div>
					))}
				</div>
			))}
		</div>
	</section>
</Layout>

<style>
	.news {
		width: 100%;
		max-width: 600px;
		margin-top: 1rem;
		margin-bottom: 2rem;
		position: relative;
	}

	.page-title {
		font-family: 'Bebas Neue', sans-serif;
		font-size: clamp(2rem, 5vw, 3rem);
		letter-spacing: 0.25em;
		font-weight: 400;
		color: #e8e6e3;
		text-align: center;
		margin-bottom: 1rem;
	}

	.news-divider {
		border: none;
		border-top: 1px solid #1a1a1d;
		margin-bottom: 3rem;
	}

	/* Hierarchical Grouping */
	.news-hierarchy {
		display: flex;
		flex-direction: column;
		gap: 4rem;
	}

	.year-group {
		position: relative;
	}

	.year-header {
		font-family: 'Bebas Neue', sans-serif;
		font-size: clamp(5rem, 15vw, 10rem);
		line-height: 0.7;
		color: #111113;
		position: absolute;
		top: -2.5rem;
		left: -2rem;
		z-index: 0;
		user-select: none;
		pointer-events: none;
		text-shadow: 1px 1px 0 rgba(255,255,255,0.02);
	}

	.month-group {
		position: relative;
		z-index: 1;
		margin-top: 2rem;
		padding-left: 1.5rem;
		border-left: 2px solid #1a1a1d;
	}

	.month-header {
		font-family: 'JetBrains Mono', monospace;
		font-size: 1.1rem;
		font-weight: 700;
		color: #e8e6e3;
		background: #0a0a0b;
		display: inline-block;
		padding: 0.4rem 1rem;
		border: 1px solid #2a2a2d;
		transform: translateX(-2.5rem);
		margin-bottom: 2rem;
		letter-spacing: 0.15em;
		box-shadow: 4px 4px 0 #111113;
		transition: transform 0.2s ease, box-shadow 0.2s ease;
	}

	.month-header:hover {
		transform: translateX(-2.5rem) translate(-2px, -2px);
		box-shadow: 6px 6px 0 rgba(201, 67, 77, 0.3);
		border-color: #c9434d;
	}

	.month-bracket {
		color: #c9434d;
		opacity: 0.7;
	}

	/* Timeline Core */
	.timeline {
		position: relative;
		padding-left: 1rem;
		margin-top: -0.5rem;
	}

	.timeline-entry {
		position: relative;
		display: flex;
		gap: 1.5rem;
		padding-bottom: 3rem;
		animation: fade-up 0.5s ease-out both;
	}

	.timeline-entry:last-child {
		padding-bottom: 1rem;
	}

	@keyframes fade-up {
		from { opacity: 0; transform: translateY(12px); }
		to { opacity: 1; transform: translateY(0); }
	}

	/* Marker */
	.timeline-marker {
		position: absolute;
		left: -1.75rem;
		top: 6px;
		display: flex;
		align-items: center;
		justify-content: center;
		z-index: 2;
	}

	.timeline-dot {
		display: block;
		width: 10px;
		height: 10px;
		border-radius: 50%;
		background: #0a0a0b;
		border: 2px solid #3a3a3d;
		transition: all 0.3s ease;
	}

	.timeline-entry:hover .timeline-dot {
		border-color: #7a7880;
		transform: scale(1.2);
	}

	.dot-current {
		background: #c9434d;
		border-color: #c9434d;
		box-shadow: 0 0 10px rgba(201, 67, 77, 0.6);
		animation: pulse-dot 2s ease-in-out infinite;
	}

	.timeline-entry:hover .dot-current {
		border-color: #fff;
		transform: scale(1.2);
	}

	@keyframes pulse-dot {
		0%, 100% { box-shadow: 0 0 10px rgba(201, 67, 77, 0.6); }
		50% { box-shadow: 0 0 20px rgba(201, 67, 77, 0.8); }
	}

	/* Content */
	.timeline-content {
		text-align: left;
		min-width: 0;
		padding-top: 2px;
	}

	.timeline-date {
		display: inline-block;
		font-size: 0.75rem;
		letter-spacing: 0.1em;
		color: #5a585f;
		margin-bottom: 0.6rem;
		font-family: 'JetBrains Mono', monospace;
		background: #111113;
		padding: 0.1rem 0.4rem;
		border-radius: 2px;
	}

	.timeline-title {
		font-family: 'JetBrains Mono', monospace;
		font-size: 1.05rem;
		font-weight: 500;
		color: #7a7880;
		margin-bottom: 0.5rem;
		line-height: 1.3;
	}

	.timeline-body {
		font-size: 0.9rem;
		line-height: 1.7;
		color: #5a585f;
	}

	/* Current entry highlight */
	.is-current .timeline-title {
		color: #e8e6e3;
	}

	.is-current .timeline-body {
		color: #e8e6e3;
	}

	.is-current .timeline-date {
		color: #e8e6e3;
		background: rgba(201, 67, 77, 0.15);
		border: 1px solid rgba(201, 67, 77, 0.3);
	}

	/* Reduced motion */
	@media (prefers-reduced-motion: reduce) {
		.timeline-entry { animation: none; }
		.dot-current { animation: none; }
	}
</style>
